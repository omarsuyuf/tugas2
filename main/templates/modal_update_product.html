<!-- Modal Update Product (AJAX) -->
<div id="product-update-backdrop" class="fixed inset-0 bg-black/50 hidden"></div>

<div id="product-update-modal" class="fixed inset-0 hidden items-center justify-center p-4 z-50">
  <div class="bg-neutral-900 text-white rounded-xl w-full max-w-lg shadow-2xl border border-neutral-800">
    <div class="px-5 py-4 border-b border-neutral-800 flex items-center justify-between">
      <h3 class="text-lg font-semibold">Edit Product</h3>
      <button type="button" class="text-neutral-400 hover:text-white" data-close-update>&times;</button>
    </div>

    <style>
      #product-update-modal input,
      #product-update-modal select,
      #product-update-modal textarea {
        width: 100%;
        padding: 0.625rem 0.75rem;
        background-color: #1f2937; 
        color: #f8fafc;            
        border: 1px solid #374151;
        border-radius: 0.5rem;
        outline: none;
        transition: border-color .2s, box-shadow .2s;
      }
      #product-update-modal input::placeholder,
      #product-update-modal textarea::placeholder { color: #9ca3af; } 

      #product-update-modal input:focus,
      #product-update-modal select:focus,
      #product-update-modal textarea:focus {
        border-color: #10b981; 
        box-shadow: 0 0 0 3px rgba(16,185,129,.15);
      }
      #product-update-modal label { color: #e5e7eb; } 

      #product-update-modal select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: none;
      }
    </style>

    <form id="productUpdateForm" class="p-5 space-y-4">
      <input type="hidden" name="__id" id="upd-id">

      <div>
        <label class="block text-sm font-medium">Name</label>
        <input type="text" name="name" id="upd-name" required placeholder="Product name">
      </div>

      <div>
        <label class="block text-sm font-medium">Price</label>
        <input type="number" name="price" id="upd-price" min="0" step="1" placeholder="0">
      </div>

      <div>
        <label class="block text-sm font-medium">Category</label>
        <select name="category" id="upd-category">
          <option value="ball">Ball</option>
          <option value="boots">Boots</option>
          <option value="jersey">Jersey</option>
          <option value="accessory">Accessory</option>
          <option value="kit">Kit</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium">Thumbnail (URL)</label>
        <input type="text" name="thumbnail" id="upd-thumbnail" placeholder="https://...">
      </div>

      <div>
        <label class="block text-sm font-medium">Description</label>
        <textarea name="description" id="upd-description" rows="3" placeholder="Add description..."></textarea>
      </div>

      <label class="inline-flex items-center gap-2 text-neutral-200">
        <input type="checkbox" name="is_featured" id="upd-featured" class="border rounded">
        <span class="text-sm">Featured</span>
      </label>

      <div class="pt-2 flex items-center justify-end gap-3">
        <button type="button" class="px-4 py-2 rounded-md border border-neutral-700 text-neutral-200 hover:bg-neutral-800" data-close-update>Cancel</button>
        <button type="submit" class="px-4 py-2 rounded-md bg-emerald-600 text-white hover:bg-emerald-700">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
const UPDATE_DETAIL_ENDPOINT = (id) => `{% url 'main:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', encodeURIComponent(id));
const UPDATE_SUBMIT_ENDPOINT = (id) => `{% url 'main:update_product_entry_ajax' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', encodeURIComponent(id));

function openUpdateModal(){ 
  document.getElementById('product-update-modal').classList.remove('hidden');
  document.getElementById('product-update-modal').classList.add('flex');
  document.getElementById('product-update-backdrop').classList.remove('hidden');
}
function closeUpdateModal(){
  document.getElementById('product-update-modal').classList.add('hidden');
  document.getElementById('product-update-modal').classList.remove('flex');
  document.getElementById('product-update-backdrop').classList.add('hidden');
}

document.querySelectorAll('[data-close-update]').forEach(btn=>{
  btn.addEventListener('click', (e)=>{ e.preventDefault(); closeUpdateModal(); });
});

// Prefill data
async function prefillUpdateForm(id){
  const res = await fetch(UPDATE_DETAIL_ENDPOINT(id), { headers: { 'Accept': 'application/json' } });
  if (!res.ok) throw new Error('Failed to load product');
  const p = await res.json();

  document.getElementById('upd-id').value = p.id || '';

  const name = (p.name ?? p.title ?? '').toString();
  document.getElementById('upd-name').value = name;

  const price = (typeof p.price === 'number' || /^\d+$/.test(p.price ?? '')) ? p.price : '';
  document.getElementById('upd-price').value = price;

  document.getElementById('upd-category').value = p.category || '';
  document.getElementById('upd-thumbnail').value = p.thumbnail || '';
  document.getElementById('upd-description').value = (p.description ?? p.content ?? '').toString();
  document.getElementById('upd-featured').checked = !!p.is_featured;
}

// Submit update
document.getElementById('productUpdateForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('upd-id').value;
  const fd = new FormData(document.getElementById('productUpdateForm'));
  fd.delete('__id'); // id di URL

  const res = await fetch(UPDATE_SUBMIT_ENDPOINT(id), { method: 'POST', body: fd });
  if (!res.ok) {
    (window.showToast ? showToast('Failed to update product', '', 'error') : alert('Failed to update product'));
    return;
  }

  closeUpdateModal();
  (window.showToast ? showToast('Product updated!', '', 'success') : console.log('Product updated'));
  document.dispatchEvent(new CustomEvent('productUpdated'));
});

// Dipanggil dari main.html saat klik edit
async function startUpdateFlow(productId){
  try {
    await prefillUpdateForm(productId);
    openUpdateModal();
  } catch (e) {
    console.error(e);
    (window.showToast ? showToast('Failed to load product data', '', 'error') : alert('Failed to load product data'));
  }
}
</script>
